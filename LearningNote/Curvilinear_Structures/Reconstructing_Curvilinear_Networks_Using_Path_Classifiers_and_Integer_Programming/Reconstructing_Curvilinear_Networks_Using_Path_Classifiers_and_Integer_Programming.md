# Reconstructing Curvilinear Networks Using Path Classifiers and Integer Programming

[toc]

- 此短句翻译

  pervasive：普遍常见的

  finalist：参赛选手

  substantial：大量的

  dramatically：显著地，明显地
  
  penalize：处罚，惩戒
  
  commensurate：等量的，相称的
  
  spurious：虚假的
  
  simultaneously：同时地
  
  voxel：体素，类似像素在2-D维度上的概念，体素于3-D维度上的概念
  
  vertex：顶点，天花板（复数形式，vertices）
  
  aerial：航拍的，航空的
  
  vascular：血管的
  
  cylindrical：圆柱形的
  
  compartment：隔间，分割
  
  mechanism：机制，原理
  
  contour：轮廓
  
  incrementally：递增地
  
  vicinity：附近
  
  filament：细丝
  
  legitimate：适当的，合理的
  
  contour：轮廓
  
  non-trivial：不平凡的，重要的
  
  inhomogeneitie：不平衡的，异质的
  
  ambiguitie：歧义
  
  integrate：积分，整合，求整体
  
  yield：产生
  
  estimate：估计，估量
  
  converge：收敛，使……聚拢
  
  conjection：连接
  
  albeit：虽然，尽管（although，连词）
  
  deviate：分离，（deviate from）
  
  meander：弯曲，漫步，徘徊
  
  histograms：直方图
  
  mechanism：机制原理
  
  invariant：不变

## Abstract

自动提取复杂包含循环的曲型结构。

将图片转化为路径图，使用甄别分类器判断路径权重，对于不同的成像方式都比较鲁棒通用。

然后通过整数规划通过结构和拓扑约束获得路径图的优化子图，也消除了不可能解。

相对于在其树状结构网络，本文的模型认可网络中循环结构的出现，能够同时表达环形或非环形的结构。

分别在道路数据集和神经数据集上验证了我们方法的有效性，且相较于之前的方法有更好的表现。

## 1 INTRODUCTION

线性结构网络在自然界和人类社会中都非常普遍，规模跨度也是极大的，从电子显微镜下的纳米神经元3-D图像，到大质量星系团，当代技术能够在短期内生成大量的上述图片。然而，尽管有丰富的可用数据和多年的持续努力，当图像数据有噪声或结构表现出复杂的形态学特征时，仍然难以实现轮廓提取的完全自动化。

因此，实际情况下，要完成上述的任务还需要昂贵耗时而无趣的人工参与。举例来说，在DIADEM映像神经细胞的挑战赛中，比赛中追踪神经轴树突和轴突最好的算法需要大量时间和努力进行校对和修正。这大大降低了分析的效率，难以在神经科学和医学研究领域中的大规模图像上应用。

问题的一部分源于，沿着路经长度根据其像素点综合评价路径的分值，尽管其他自动化的方式都是使用类似方法，但是，这种方法不能有效抑制捷径，因此难以计算不同长度的路径得分。另一个困难在于很多我们需要去提取的结构，比如道路或者血管是含有循环路径的，而当前的方法极少关注于这一方面。此外，即使在真正是树状结构的结构中，比如神经元，成像分辨率往往很低，以至于分支似乎交叉，从而引入几个虚假的循环，这只有在整个结构恢复后才能识别出来。事实上，这是错误的主要来源之一。

本文，我们将尝试将 路径重建问题 看作 解 可能通路路径图上的整数优化（IP）问题 来同时克服这些问题。我们进一步提出了使用区别训练的路径分类器来评价路径得分的方法。

具体而言，我们首先选择可能属于被关注的线性结构的空间上的等距体素（voxels），我们把它作为图中的节点，使用**测地线**将一定距离内的顶点连接起来，然后用最初的分类方法为其赋予分数。然后寻找能够最大化 基于全图和几何特性的全局目标函数。与早期致力于创建树结构的方法不同，我们希望能够建立允许存在循环的子图结构，同时能够抑制虚假节点和早期分支终止节点（这里的翻译有问题的，我猜应该是 路径中过早结束形成的端点，原文：early branch terminations）。这是通过让图顶点被几个分支使用来实现的，从而允许循环，但我们同样引入正则化先验条件和结构约束来限制分支和终止节点的数量。

上述问题以及我们提及的方法情形呈现如下：

![image-20210126203027558](D:\Documents\PaperLibraries\LearningNote\Curvilinear_Structures\Reconstructing_Curvilinear_Networks_Using_Path_Classifiers_and_Integer_Programming\assets\image-20210126203027558.png)

强制以树形结构建模，会导致虚假的连接。如（a）图中有两个交叉分支，并通过最大化通达测度（不清楚具体是什么算法🤣）得到路径图中中心线的采样点。有一个交点被设置为了黄色，这是因为在3-D情形下，这两个分支很可能是并不相交的，仅仅是因为在2-D情况下，z轴的分辨力不够有效，而难以区分。（b）图中使用了测地线连接了采样点构成了图。（c，d）图是在（b）图的基础上通过最小化全局耗费函数得到子图，最后得到轮廓结果。（c）图中我们避免了节点多次被使用，其最后结果并不好。（d）图中我们允许黄色节点被使用两次，并惩罚了过早结束产生的断点以及错误连接，最后获得了更好的效果。

我们的方法最早在“Automated reconstruction of tree structures using path classifiers and mixed integer programming”和“Reconstructing loopy curvilinear structures using integer programming”中出现，同样是在连接处进行了重构。我们结合了他们的想法，提出了新的连接约束和新的优化策略来实现他们，从而在速度上有了很大的提升。此外，我们还通过新的实验和与其他几种方法的比较，提供了更全面的验证。

我们在大量噪声2-D和3-D数据集（道路航拍数据集，显微神经血管数据集）上验证了我们方法的有效性，我们的方法保持着一贯的优异。

## 2 RELATED WORK

多数提取轮廓和线性结构的数据集使用序列化的圆柱形片段作为线性结构的表示方式。如此表示除了紧凑之外，还有两个重要的特性，即连通性和方向性，这两个特性在很多结构中非常常见，譬如血管和神经，而且对于研究他们的形态学特征非常重要。当前方法可以被粗略的划分为手工，半自动，全自动三种。由于我们关注的是自动化，所以我们在附录A中讨论了前两个类别，也简要的回顾了现有的自动化技术。多数都需要在图中为每个连通网络找到一个起点，即根节点，而后从根节点开始，根据局部管状最大度量延展出分支，局部管状最大度量代表着点位于曲线结构中心线上的可能性。根据所采用的搜索机制，现有的算法可以细分为局部算法和全局算法，如下所述。

### 2.1 Local Search

局部搜索算法使用贪婪原则基于局部图像信息判断解决方案中应保留的分支。他们包括分割和勾勒通道图以及激活由通道图初始的基于轮廓的方法（原文“They include methods that segment and skeletonize the tubularity image, and active contour-based methods, which are initialized from it”）。当分割结果足够可靠的时候，这样的方法是有效而且高效的。但是，实际上这很难实现，尤其精简之后的方法在噪音数据集上常会产生断开的元素和碎片，因此需要周全的后处理和分析将断片组成有意义的网络。

另一重要的局部方法需要涉及准确描摹曲线网络。通过贪婪追踪方法从一系列种子起点，然后通过估计通道测量来逐步增长分支。高评分通路会迭代地添加到解决方案中，而他们的终点会作为下次路径迭代的起点。这些算法是非常高效的，它只需要考虑节点附近图像子集，计算其通道测量值。但是，他们通常需要额外处理检测获得路径节点。此外，由于他们采取了贪婪算法，图像的伪影和噪声会产生能够传播的局部跟踪误差。最终常常导致巨大的形态学错误，尤其当路径之间有较大间隙时，情况更加严重。

### 2.2 Global Search

全局方法致力于通过计算整体的通道测量值获得更好的鲁棒性。尽管这会带来更大的计算量但能够通过将其转换到傅里叶空间或者使用GPU计算来解决。然后在高通道评分节点或者超像素构成的图上计算全局目标函数。举例而言，马尔科夫链算法就是这一类的方法，为了提高他们搜索空间的效率，他们首先采样起始节点，连接他们并通过迭代调整他们的位置和连接以达到最小化目标函数的目的。但是，尽管这些方法能通用的产生平滑的树分量（tree components）但是却并不能保证这些分量的空间连通性。

除上述之外，其他基于图的方法使用特定的根节点来确保连通性，他们采样得出起始节点并根据路径局部最大通道测量来连接节点，这就形成了一张图中点点是种子节点，图中边是路径的节点图。图的边缘构成了可能的曲线结构的过完全表示，最后一步就是在候选边中选出最优子图获得解决方案。

多数现存方法会给边赋予一定权重，并以求解最小权重树的观点求取该问题的最优解。最小生成树算法（MST）和最短路径树（SPT）算法都是这一类。尽管对于基于MST和SPT的公式存在高效的多项式时间算法，这些算法必须考虑所有的种子节点（seed points），包括那些可能错误的归类到正确中的节点。导致的结果就是当存在被误分到结构中的节点时会形成了虚假的分支，这样的现象在有噪音的数据中非常普遍。当然，有些错误分支能够通过修建来消除。在之后的结果部分，我们会比较修枝算法和我们的IP方法，同时也将证明，后者往往能够得到更好的结果。

我们早期的“k-Minimum Spanning Tree”（k-MST）算法，以解决根据先验集合中$k$个种子节点来生成最小代价树的方式解决上述问题。但是，这种方法依赖于启发式算法和两个独立的函数，一个用于搜索，一个用于评分，难以保证最后结果的全局最优。此外，他还需要对与实际问题并无联系的超参数$k$进行额外优化。而本论文提及的整数规划（integer programming formulation）仅需要最小化单一的全局目标函数来连接合理的种子节点，同时通过在不超过用户指定的容错范围内找到最优解来消除伪种子节点。

此外，所有基于生成树的方法都依赖于局部通道分数来赋予边的权重，举例而言，依据测地距离的全局方法用通道值函数积分作为边权重的设置。类似地，基于轮廓有效方法（这里的翻译不一定准确，原文“active contour-based methods”）通常定义他们的能量为路径的积分（挺奇怪的，没明白说的是什么）。在我们的实验中，因为他们涉及均值，这样测量指标难以有效的忽略虽然大部分存在曲型结构但仍有部分在背景的路径。而且，由于评分依据路径上的值的和计算，因此对不同长度的路径进行归一化使得他们能够比较是非常重要的。不同的是，我们将在Section 5介绍路径分类如何比较任意长度路径的概率代价。除上述之外，我们的路径特征提取了全局的特征，面对噪音和异质性能有比较好的鲁棒特征。

最后一点，当前并没有方法解决循环结构的轮廓提取工作。

对于由于3-D图像组分辨率过低或是结构在2-D投影的影响，而形成的伪环情况，上述提及的方法中部分方法尝试通过惩罚急转弯和高弯路径，引入局部和贪婪启发式规则来解决歧义，进而区分合理交点和虚假交叉。但是他们难以确保全局的最优，容易囿于局部优化的结果。这也是我们尝试通过目标函数全局优化解决的问题。

## 3 APPROACH

我们首先简单的介绍我们算法，算法流程中可视结果如下

![image-20210131122620708](D:\Documents\PaperLibraries\LearningNote\Curvilinear_Structures\Reconstructing_Curvilinear_Networks_Using_Path_Classifiers_and_Integer_Programming\assets\image-20210131122620708.png)

图（a）航拍的郊区图，图（b）3-D空间通道图，图（c）红色点代表种子节点，绿色是路径的中心线，图（d）红色代表路径分类结果概率高的边，蓝色代表路径分类概率低的边，只有当路径与道路重合的时候，路径才会标识为红色，图（e）通过我们方法重建后的结果

流程如下：

1. 我们首先计算每张图片位置$x_i$的通道值和半径$r_i$，通过$r_i$衡量在以$x_i$为圆心，$r_i$为半径的存在通道结构的可能性。对于给定的$N-D$图片，根据上述，将会产生$(N+1)-D$空间维度的通道体，如上图中的（b）
2. 我们选择分布规则，间隔均匀的高通量节点作为种子节点，同时连接不超过一定范围（人为设定的）的点对。如此便可以获得有向通道图，正如上图中的（c），是可能的曲型结构的过充分表达，即曲形网络的超集
3. 通过步骤2中的图和ground-truth训练路径分类器，我们在检测阶段对图中每一相连的边赋予一定的权重，结果如上图中的（d）
4. 使用步骤3中的权重，通过整数规划计算步骤2中过充分图的最大似然有向子图，获得最终的结果，如上图中的（e）

上述四个步骤基本和大多数从种子节点建立起树结构的算法流程相同，唯有三个关键区别。

- 不论是启发式优化算法采用$MST + pruning$（最小生成树后经过剪枝）还是$k-MST$算法都难以保证优化性。我们的方法则能确保结果在全局优化结果的可允许误差范围内
- 我们使用分类器为每一条路径进行评分，而不是传统的整合像素值进行评分。如此，在数据有噪声时，我们有更加鲁棒的结果，同时能够获得概率分布峰谷图，如上图中的（d），能够确保优化的结果贴近ground-truth
- 我们并没有约束子图是树状结构，而是允许网络结构中包含环形，能够惩罚虚假的连接以及路径过早终止现象

在结果呈现阶段，我们会展示上面的措施在不同数据集上都产生了不错的效果。

## 4 GRAPH CONSTRUCTION

我们按照以下四步建立上图Fig.3中的（c）图：

1. 首先计算多向管道通量，用来评判某一体素是否处在给定尺度的通道中心，与传统定向通量依赖于圆形截面且只有两个不同的半径不同，多向管道测量能够通过最大化多方向和半径的图像梯度通量来实现计算生物学上经常出现的任意形状的图像

2. 然后我们使用NMST算法抑制抑制围绕通道中心线的非极大值响应，有利于消除后续处理中可能遇见的错误。具体而言，NMST算法会抑制在垂直于局部方向估计平面上且在尺度定义的原型邻域内的非局部最大体素。然后计算通道测量的MST结果，按照MST结果路径连接非极大抑制后结果中不相连的组件对

3. 接着，选取结果图形中通道测量最大的节点们作为图的节点或是长子节点，有待下一步的连接。他们将按照贪婪原则进行选取，每点与之前选取的任一节点最小距离都为$d$，（这一步其实都不是特别的理解）

4. 最后在空间域根据最小路径算法连接每一对点间距离小于一定距离$l(d)$的点对，我们取顶点$i$和$j$之间的测地线通道路径长为：
   $$
   p_{ij}=\mathop{\arg \min}_{\gamma} \int_{0}^{1} \mathcal{P}(\gamma(s))ds
   $$
   $\mathcal{P}$：通道测量的负指数映射

   $s \in [0, 1]$：$s$属于区间$[0, 1]$，代表弧度参数

   $\gamma$：将$s$映射到$\mathbb{R}^{N+1}$域的参数曲线（即某一函数）

   $\mathbb{R}^{N+1}$：$N$代表空间上的维度，而$1$则代表着尺度

   通过Runge-Kutta gradient descent算法（龙格-库塔梯度下降算法）来进行通过Fast Marching algorithm（快速行进算法）匹配得到的测地距离的最小化。

## 5 PATH CLASSIFICATION

一旦graph（图）已经建立，我们方法的一个关键，同时也是本文最重要的一个贡献，就是如何为每一连续边赋予一定权重。如上面的Fig.3中的（d），我们的方法会选择出较少部分边赋予较大分值，如此能够极大地简化步骤4中整数优化过程（the IP solver）。事实上，我们验证了如果没有这一特性，整数优化难以收敛。此外，我们将会在Section 7中演示在其它方法中使用上述的权重同样有助于寻找需要的子图，虽然提升效果不如使用IP solver。

一般计算边权重的方法是求取路径通道上的值的函数积分，但是正如下图（a）所示：

![image-20210206100755829](D:\Documents\PaperLibraries\LearningNote\Curvilinear_Structures\Reconstructing_Curvilinear_Networks_Using_Path_Classifiers_and_Integer_Programming\assets\image-20210206100755829.png)

其结果并不可靠，沿着路径的占少数的高分会被低值所抵消，平均掉，因此难以充分的惩处虚假分支以及捷径。此外，使用经典方法难以很好维持既不让路径过分平直又能够防止他们过于曲折的平衡，因此会产生上图中（b）图的结果，而我们的方法能够获得比较好的结构。

在这一节选中，我们提出了一个更加可靠的路径分类算法计算概率估计。具体而言，对于Section 4中给出的通道图，我们把它分为几个部分，基于梯度直方图计算特征向量。然后通过嵌入算法（embedding approach）从我们计算得到的可能的任意数量的特征向量中计算固定大小的描述符（fixed-size descriptors），最后我们把这些描述符喂入分类器中，然后将输出转换为概率估计。

如上图中（b），这一方法惩罚了那些虽然基本还是按照树结构但是却穿过了背景的方法。因此，相较于积分方法，他能抑制捷径和虚假分支。

本节剩余部分我们将详细介绍，我们的路径特征，嵌入方案，训练数据收集机制。

### 5.1 Histogram of Gradient Deviation (HOG) Descriptors

梯度差异直方图描述符

在物体检测和视频动作识别中，方向梯度直方图是比较有效果的。

通常，图片首先被分为由多个固定大小块组成的网格，每一块叫做Cell，然后对每一Cell根据其内像素的值，计算1-D（一维）梯度方向直方图。临近的Cell的直方图会再组合归一化获得不受局部对比度变化的特征，最后会把这些特征传入分类器中检测目标。

通过下面定义梯度偏差直方图(HGD)描述符的方式，我们将此策略应用于管状路径

对于给定的如下图中的通道路径$\gamma(s)$

![image-20210207132644609](D:\Documents\PaperLibraries\LearningNote\Curvilinear_Structures\Reconstructing_Curvilinear_Networks_Using_Path_Classifiers_and_Integer_Programming\assets\image-20210207132644609.png)

$s$：曲线的横坐标

$C(s)$：中心线方程

$r(s)$：对应的半径映射

我们把每条路径分为等长的覆盖分割片段$\gamma_i(s)$，并根据分割结果中$x \in \gamma_i(s)$的像素点计算图片梯度$\nabla I(x)$和法向量$N(x)$之间的夹角直方图。

为了确保路径周围的所有梯度信息都已被获取，我们根据与半径成一定比例的边距$m(s)=\beta \  * \  r(s) $扩大了分割。固定大小的边距并不是为了避免狭窄的路径的背景梯度的偏置干扰（不清楚这是什么意思，原文，A fixed size margin is not preferred to avoid biased interference of background gradients for thin paths）

此外，如上图，为了获得路径横截面外观描述符，我们将管状分割结果分成以$R$为间距的等间隔的环形，同时为每一间隔计算两个直方图，第一个直方图代表每一间隔内的梯度场强度，第二个间隔代表管状结构关于其中心线的对称情况。

对于给定的点$x \in \gamma_i(s)$，

$C(s_x)$代表最近的中心线点

$N(x)$代表从$C(s_x)$到$x$的法向量（因为是从中心点指向柱面上某点，故可视为法向量）

基于上述表示，每一点都影响了梯度强度和梯度对称直方图统计。

其统计量化可按照如下进行：
$$
\Psi(x) =
\begin{cases}
angle(\nabla I(x), N(x)), & \mbox{if} \left \| x - C(s_x) \right \| \gt \varepsilon \\
angle(\nabla I(x), \prod(x)), &otherwise,
\end{cases} 
$$


